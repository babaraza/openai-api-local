<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenAI API</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
      integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/atom-one-dark.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
      pre {
        border-radius: 0.375rem;
      }

      .copyBtn {
        cursor: pointer;
      }

      #darkmode {
        position: absolute;
        top: 20px;
        right: 30px;
      }

      .header_div {
        display: flex;
        padding: 10px;
        justify-content: space-between;
        font-size: 0.75rem;
        background-color: #373b46;
        color: #cdcdcd;
      }

      #usage {
        position: absolute;
        /* bottom: 10px; */
        left: 10px;
        font-size: 10px;
        opacity: 0.5;
      }

      img[alt="Generated Image"] {
        width: 50%;
      }

      .app {
        margin-top: 20vh;
      }

      .loading {
        display: flex;
        gap: 1%;
        align-items: center;
      }

      #info {
        display: none;
        font-size: 12px;
        margin-top: 20px;
      }

      code {
        white-space: pre-wrap;
      }

      .output_area {
        display: none;
        min-height: 100px;
      }

      .vision_options,
      .dalle_options,
      .tts_options,
      .loading_main,
      #player {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div id="darkmode">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="btnSwitch" checked />
          <label class="form-check-label" for="btnSwitch">Dark Mode</label>
        </div>
      </div>
      <div class="input_area container mb-3">
        <form action="" onsubmit="runAI(event)" enctype="multipart/form-data" class="was-validated">
          <div class="row">
            <div class="mb-3">
              <label for="prompt" class="form-label">Prompt</label>
              <input
                class="form-control form-control-sm"
                type="text"
                name="prompt"
                id="prompt"
                required
              />
              <div class="invalid-feedback">Please enter a prompt</div>
            </div>
          </div>
          <div class="row">
            <div class="col-auto">
              <label for="models">Models</label>
              <select id="models" class="form-select form-select-sm mb-3">
                <option value="gpt-4-turbo-preview">GPT-4 Turbo Preview</option>
                <option selected value="gpt-3.5-turbo-0125">GPT-3.5 Turbo</option>
                <option value="dall-e-3">DALL-E 3</option>
                <option value="gpt-4-vision-preview">GPT-4 Vision Preview</option>
                <option value="tts-1">TTS-1</option>
              </select>
            </div>
          </div>
          <div class="dalle_options" id="dalle_options">
            <div class="row mb-3">
              <div class="col dalle_resolution">
                <label for="dalle_resolution">Resolution</label>
                <select id="dalle_resolution" class="form-select form-select-sm">
                  <option selected value="1024x1024">1024x1024</option>
                  <option value="1792x1024">1792x1024</option>
                  <option value="1024x1792">1024x1792</option>
                </select>
              </div>
              <div class="col dalle_style">
                <label for="dalle_style">Style</label>
                <select id="dalle_style" class="form-select form-select-sm">
                  <option selected value="vivid">Vivid</option>
                  <option value="natural">Natural</option>
                </select>
              </div>
              <div class="col dalle_image_quality">
                <label for="dalle_image_quality">Image Quality</label>
                <select id="dalle_image_quality" class="form-select form-select-sm">
                  <option selected value="standard">Standard</option>
                  <option value="hd">HD</option>
                </select>
              </div>
            </div>
          </div>
          <div class="vision_options" id="vision_options">
            <div class="row">
              <div class="col image_upload" id="image_upload">
                <label for="uploaded_image">Upload Image</label>
                <input
                  type="file"
                  id="uploaded_image"
                  accept="image/*"
                  onchange="previewImage(event)"
                  class="form-control form-control-sm mb-3"
                />
              </div>
              <div class="col">
                <label for="tokens_vision">Max Tokens</label>
                <input
                  type="number"
                  class="form-control form-control-sm"
                  id="tokens_vision"
                  placeholder="Default: 20"
                />
              </div>
              <div class="col">
                <label for="vision_detail">Image Detail</label>
                <select id="vision_detail" class="form-select form-select-sm">
                  <option selected value="low">Low</option>
                  <option value="high">High</option>
                </select>
              </div>
            </div>
            <img id="image-preview" style="max-width: 100%; max-height: 300px" class="mb-3" />
          </div>
          <div class="tts_options mb-3" id="tts_options">
            <div class="row">
              <div class="col-auto">
                <label for="tts_voice">Voice</label>
                <select id="tts_voice" class="form-select form-select-sm">
                  <option selected value="alloy">alloy</option>
                  <option value="echo">echo</option>
                  <option value="fable">fable</option>
                  <option value="onyx">onyx</option>
                  <option value="nova">nova</option>
                  <option value="shimmer">shimmer</option>
                </select>
              </div>
            </div>
          </div>
          <button class="btn btn-primary btn-sm" type="submit">Submit</button>
        </form>
      </div>
      <div class="loading_main container" id="loading_main">
        <div class="loading">
          <div class="spinner-border spinner-border-sm" aria-hidden="true"></div>
          <div>loading</div>
        </div>
      </div>

      <div class="output_area container placeholder-glow">
        <b>Result</b>
        <div id="output"></div>
        <div id="info"></div>
        <audio class="mb-3" id="player" controls>
          Your browser does not support the audio element.
        </audio>
      </div>
      <div id="usage"></div>
    </div>

    <script>
      const API_KEY = "";
      const output = document.getElementById("output");
      document.getElementById("models").addEventListener("change", show_options);

      function show_options(event) {
        const value = event.target.value;

        if (value === "gpt-4-turbo-preview" || value === "gpt-3.5-turbo-0125") {
          showGPTOptions();
        } else if (value === "dall-e-3") {
          showDalleOptions();
        } else if (value === "tts-1") {
          showTTSOptions();
        } else if (value === "gpt-4-vision-preview") {
          showVisionOptions();
        }
      }

      function showGPTOptions() {
        $("#dalle_options, #info, #vision_options, #tts_options, #player").hide();
        $("#output").show();
        $("#prompt").attr("required", "");
      }

      function showTTSOptions() {
        $("#player, #tts_options").show();
        $("#dalle_options, #info, #vision_options, #output").hide();
        $("#uploaded_image").removeAttr("required");
        $("#prompt").attr("required", "");
      }

      function showVisionOptions() {
        $("#vision_options, #output").show();
        $("#dalle_options, #info, #tts_options, #player").hide();
        $("#prompt").removeAttr("required");
        $("#uploaded_image").attr("required", "");
      }

      function showDalleOptions() {
        $("#dalle_options, #info, #output").show();
        $("#vision_options, #tts_options, #player").hide();
        $("#prompt").attr("required", "");
        $("#uploaded_image").removeAttr("required");
      }

      function runAI(event) {
        event.preventDefault();
        const prompt = $("#prompt");

        let chosen_model = $("#models").val();
        let data = {};
        let endpoint = "";

        // GPT4
        if (chosen_model == "gpt-4-turbo-preview" || chosen_model == "gpt-3.5-turbo-0125") {
          endpoint = "chat/completions";
          data = {
            model: chosen_model,
            messages: [{ role: "user", content: prompt.val() }],
            temperature: 0.7,
            // max_tokens: 64,
          };
        }
        // TTS
        else if (chosen_model == "tts-1") {
          endpoint = "audio/speech";
          data = {
            model: chosen_model,
            input: prompt.val(),
            voice: $("#tts_voice").val(),
          };
        }
        // DALLe-3
        else if (chosen_model == "dall-e-3") {
          endpoint = "images/generations";
          data = {
            model: chosen_model,
            prompt: prompt.val(),
            quality: $("#dalle_image_quality").val(),
            style: $("#dalle_style").val(),
            n: 1,
            size: $("#dalle_resolution").val(),
          };
        }
        // VISION
        else if (chosen_model == "gpt-4-vision-preview") {
          endpoint = "chat/completions";
          data = {
            model: chosen_model,
            messages: [
              {
                role: "user",
                content: [
                  { type: "text", text: "What’s in this image?" },
                  {
                    type: "image_url",
                    image_url: {
                      url: uploaded_image,
                      detail: $("#vision_detail").val(),
                    },
                  },
                ],
              },
            ],
            max_tokens: $("#tokens_vision").val() ? parseInt($("#tokens_vision").val(), 10) : 20,
          };
        }

        const options = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${API_KEY}`,
          },
          body: JSON.stringify(data),
        };
        // console.log(data);
        // throw new Error("DEBUG");
        api_call(options, endpoint, chosen_model);
        show_loading();
      }

      async function api_call(options, endpoint, chosen_model) {
        try {
          const response = await fetch(`https://api.openai.com/v1/${endpoint}`, options);
          if (chosen_model != "tts-1") {
            const result = await response.json();
            await display_result(result, chosen_model);
            console.log("%c Result -", "font-weight:bold", new Date().toLocaleTimeString([], { hour: '2-digit', minute: "2-digit" }),result);
          } else {
            const result = await response.blob();
            await display_result(result, chosen_model);
          }
        } catch (error) {
          console.error("An error occurred:", error);
          alert("An error occurred. Please check the console for details.");
        }
      }

      function add_header_to_code_block() {
        if ($("code").length) {
          const lang = $("code").attr("class").split(" ")[0].split("-")[1];
          // console.log(lang);
          let header_div = `<div class="header_div"><div>${lang}</div><div class="copyBtn" onclick="copyCode()">copy</div></div>`;
          $(header_div).prependTo("pre");
        } else {
          console.log("response doesnt include <code> tags");
        }
      }

      function display_result(result, chosen_model) {
        close_loading();
        $(".output_area").show();
        // check which model was used
        if (
          chosen_model === "gpt-4-turbo-preview" ||
          chosen_model === "gpt-3.5-turbo-0125" ||
          chosen_model === "gpt-4-vision-preview"
        ) {
          output.innerHTML = marked.parse(result.choices[0].message.content);
          hljs.highlightAll();
          add_header_to_code_block();
        } else if (chosen_model === "dall-e-3") {
          output.innerHTML = marked.parse(`![Generated Image](${result.data[0].url})`);
          $("#info").html(
            `<a href="${result.data[0].url}">Full Size Image</a><br><br><b>Revised Prompt:</b><br>${result.data[0].revised_prompt}`
          );
        } else if (chosen_model === "tts-1") {
          var url = URL.createObjectURL(result);
          $("#player").attr("src", url);
        }
      }

      function show_loading() {
        $("#loading_main").show();
        output.classList.add("placeholder");
      }

      function close_loading() {
        $("#loading_main").hide();
        output.classList.remove("placeholder");
      }

      function previewImage(event) {
        const reader = new FileReader();
        reader.onload = function () {
          $("#image-preview").attr("src", reader.result);
          $("#image-preview").show();
          uploaded_image = reader.result;
        };
        reader.readAsDataURL(event.target.files[0]);
      }

      document.getElementById("btnSwitch").addEventListener("click", () => {
        const currentTheme = document.documentElement.getAttribute("data-bs-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-bs-theme", newTheme);
      });

      async function get_usage() {
        try {
          const formattedDate = new Date().toISOString().slice(0, 10);
          const response = await fetch(`https://api.openai.com/v1/usage?date=${formattedDate}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${API_KEY}`,
            },
          });
          if (!response.ok) throw new Error("Failed to fetch usage data");
          const result = await response.json();
          console.log("%c Usage checked at", "font-weight:bold", new Date().toLocaleTimeString([], { hour: '2-digit', minute: "2-digit" }), result);
          showUsage(calculateTotalUsage(result));
        } catch (error) {
          console.error("An error occurred:", error);
          alert("An error occurred. Please check the console for details.");
        }
      }

      function copyCode() {
        var codeBlock = document.querySelector("code");
        navigator.clipboard.writeText(codeBlock.innerText);
      }

      function calculateTotalUsage(data) {
        const prices = {
          "gpt-3.5-turbo-0125": {
            n_context_tokens_total: 0.0005,
            n_generated_tokens_total: 0.0015,
          },
          "gpt-4-1106-vision-preview": {
            n_context_tokens_total: 0.01,
            n_generated_tokens_total: 0.03,
          },
          "gpt-4-0125-preview": {
            n_context_tokens_total: 0.01,
            n_generated_tokens_total: 0.03,
          },
          "dall-e-3": {
            generations: 0.08,
          },
          "tts-1": {
            speech: 0.015,
          },
        };
        // Initialize the total usage as zero

        let totalUsage = 0;

        // Initialize the variables for the input tokens, output tokens, requests, images, and characters for each model and operation

        let gpt3 = {
          n_context_tokens_total: 0,
          n_generated_tokens_total: 0,
        };
        let gpt4 = {
          n_context_tokens_total: 0,
          n_generated_tokens_total: 0,
        };
        let gpt4Vision = {
          n_context_tokens_total: 0,
          n_generated_tokens_total: 0,
        };
        let dalleApiTotals = {
          totalNumImages: 0,
        };
        let ttsTotals = {
          totalCharacters: 0,
        };

        // Loop through the data arrays for each model and operation
        for (let key in data) {
          // Skip the non-array properties
          if (!Array.isArray(data[key])) continue;

          // Loop through the objects in each array
          for (let obj of data[key]) {
            // Get the model id and the operation from the object
            let modelId = obj.model_id || obj.snapshot_id;

            // Get the values of the input tokens, output tokens, requests, images, and characters from the object
            let inputTokens = obj.n_context_tokens_total || 0;
            let outputTokens = obj.n_generated_tokens_total || 0;
            let images = obj.num_images || 0;
            let characters = obj.num_characters || 0;
            let cost = 0;

            // Update the variables for the input tokens, output tokens, requests, images, and characters for each model and operation
            if (modelId === "gpt-4-0125-preview") {
              gpt4.n_context_tokens_total += inputTokens;
              gpt4.n_generated_tokens_total += outputTokens;
              cost =
                (inputTokens * prices[modelId].n_context_tokens_total +
                  outputTokens * prices[modelId].n_generated_tokens_total) /
                1000;
            } else if (modelId === "gpt-4-1106-vision-preview") {
              gpt4Vision.n_context_tokens_total += inputTokens;
              gpt4Vision.n_generated_tokens_total += outputTokens;
              cost =
                (inputTokens * prices[modelId].n_context_tokens_total +
                  outputTokens * prices[modelId].n_generated_tokens_total) /
                1000;
            } else if (modelId === "dall-e-3") {
              dalleApiTotals.totalNumImages += images;
              cost = images * prices[modelId].generations;
            } else if (modelId === "tts-1") {
              ttsTotals.totalCharacters += characters;
              cost = (characters * prices[modelId].speech) / 1000;
            } else if (modelId === "gpt-3.5-turbo-0125") {
              gpt3.n_context_tokens_total += inputTokens;
              gpt3.n_generated_tokens_total += outputTokens;
              cost =
                (inputTokens * prices[modelId].n_context_tokens_total +
                  outputTokens * prices[modelId].n_generated_tokens_total) /
                1000;
            }

            totalUsage += cost;
          }
        }
        totalUsage = totalUsage.toFixed(2);

        // Return the total usage and the variables for the input tokens, output tokens, requests, images, and characters for each model and operation
        return {
          totalUsage,
          gpt3,
          gpt4,
          gpt4Vision,
          dalleApiTotals,
          ttsTotals,
        };
      }

      function showUsage(usage) {
        document.getElementById("usage").innerHTML = `
                          GPT 3: Input: ${usage.gpt3.n_context_tokens_total} / Generated: ${usage.gpt3.n_generated_tokens_total}<br>
                          GPT 4: Input: ${usage.gpt4.n_context_tokens_total} / Generated: ${usage.gpt4.n_generated_tokens_total}<br>
                          GPT 4 Vision: Input: ${usage.gpt4Vision.n_context_tokens_total} / Generated: ${usage.gpt4Vision.n_generated_tokens_total}<br>
                          Dalle 3: Total Images: ${usage.dalleApiTotals.totalNumImages}<br>
                          TTS: Total Characters: ${usage.ttsTotals.totalCharacters}<br>
                          Total Cost: $${usage.totalUsage}
                        `;
      }

      get_usage();
    </script>
  </body>
</html>
